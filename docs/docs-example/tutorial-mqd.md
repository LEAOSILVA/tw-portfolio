---
parent: tutorials
sidebar_position: 1
---

# Data Quality Engine

> **Context**
>
> This tutorial explains how to integrate an API Platform and a software that distributes events in real time. The objective of this integration is to help Open Finance customers in Brazil comply with Central Bank requirements. 

**Data Quality Engine** (_Motor de Qualidade de Dados_ or _MQD_ in Portuguese) is the open-source tool that evaluates the quality of data shared among participants of [Open Finance](https://openfinancebrasil.atlassian.net/wiki/spaces/OF/pages/362578565/Motor+de+Qualidade+de+Dados), ensuring the integrity of the information.

Sensedia provides tools to facilitate integration between the **Sensedia API Platform**, **Events Hub**, and **MQD**, enabling efficient data processing.

The diagram illustrates this integration:

![Integration flow between MQD, Events Hub, and API Manager](./img/mqd-flow.png)

The diagram presents an Open Finance integration flow, where the **Sensedia API Platform** acts as the publisher of APIs eligible for MQD â€” such as accounts, cards, and loans.

Events generated by these APIs are asynchronously published to the **Sensedia Events Hub**, which consumes them, applies policies, classifies them, and forwards them via the MQD Subscriber API to the Financial Institution's proxy.

This process ensures efficient, secure, and controlled data delivery.

Below is the step-by-step guide for integration:

---

### Step 1: Configuring Events Hub

Access **Events Hub** and perform the following actions:

#### Create a context

1. Create a context and fill in the required fields (name and path), as shown in the image below:

   ![MQD context creation screen](./img/create-context.png)

   :::note[NOTE] 
   Consult more information on configuring **contexts**.
   :::

#### Create a handler

1. Create a handler, which will be the **MQD Handler**. You will go through 4 sections to configure the handler: **Overview, Topics, Policy and Review**.

2. In the **Overview** section, fill in the fields with the required information. 

3. In the **Topics** section:

   a. Add client topics, e.g., `accounts`, `consents`, `creditCardAccounts`. You must configure one topic for each API eligible for MQD, as shown in the image below: 

   ![MQD topic configuration](./img/mqd-topics.png)  
    
   b. Enable the context in each topic by clicking the magnifying glass.

     > **Event publication URL**  
     >  
     > Each topic creates a publication URL, which must be configured in the Custom JS interceptor of the data APIs.  
     >  
     > See an example of a URL created by the Events Hub:  
     > ![Example of MQD topic URL](./img/example-url.png)

4. In the **Policy** section: 

   a. Create an **IP Filtering Validation** policy, specific to the outbound IPs of the Sensedia API Platform.

   :::important[IMPORTANT] 
   To check the IPs of the Sensedia API Platform, access the **Infrastructure Manager**.
   :::

   Once logged into the platform, append `/info` directly to the end of the URL, as shown below:  

   ```
   https://manager-example.sensedia.com/api-management/info/
   ```
   :::

   b. Fill in the delivery settings fields:

    - Retry count
    - Codes for automatic retries: `500`, `502`, `503`, `504`, `408`
    - Request timeout

      Once registered, the information should appear as follows:

      ![IP Filtering Validation Policy](./img/mqd-data-policy.png)

      :::note[NOTE] 
      Consult more information on configuring **handlers**
      :::

5. In the **Review** section, review the information and save it.

#### Create a subscriber

1. Create a subscriber, which will be the **MQD subscriber API**. You will go through 4 sections to configure the subscriber: **Overview, Security, Topics and Review**.

![Registered MQD Subscriber](./img/mqd-subscriber.png)

2. In the **Overview** section, fill in the fields with the required information. 

3. In the **Security** section, validate the key and create a static token for the subscriber (optional).

4. In the **Topics** section:

   a. Select the MQD Handler, then select the client topics. Enable the **Publish** option.

   b. Fill in the **Subscriber URL** field with the endpoint of the MQD subscriber API.

   c. Add the status code `200` in the corresponding field.

   ![MQD subscriber configuration](./img/config-subscriber.png)

:::note[NOTE] 
If the API is inactive at the time of registration, the subscriber status will appear gray, but this does not mean it is inactive.  

Consult more information on configuring **subscribers**.
:::

5. In the **Review** section, review the information and save it.

---

### Step 2: Configuring the MQD subscriber API

Access the **API Platform** and perform the actions below.

You will now configure the **MQD subscriber API**, which will act as a proxy with the financial institution's environment.  

This API will be responsible for receiving data from the Events Hub and forwarding it to MQD.

When configuring this API:

1. In the **Resources** step, add a resource. For example: `v1/report-data`.
2. In the **Flows** step:

   a. Insert the URL that will be the API's destination, which varies depending on the API to be exposed.  

      ![API destination configuration](./img/api-destination.png)

   b. Add the following interceptors:

     - **IP Filtering**: with the outbound IPs of Events Hub (check the IPs with the support team).

     - **Access Token Validation**: the same inserted in Events Hub.

     - **Custom JS**: will manipulate the header for MQD format. You can customize it for the client by removing some unnecessary headers.  

       Check the Custom JS interceptor in the API flow: 

       ![JS interceptor in MQD Subscriber API](./img/mqd-api-interceptor.png)

       You can configure the JS interceptor as follows:

       ```javascript title="Configuring the JS interceptor"
       const scriptName = String("MQD - Event Subscriber Interceptor ");
       const scriptVersion = String("1.0.0");
       try {
           $call.tracer.trace(">Sensedia debug => Custom javascript: Name [ "+scriptName+" ] version [ "+scriptVersion+" ]." );
           var json = JSON.parse( $call.request.getBody().getString( "utf-8" ) );
           $request.setHeader("endpointName", json.mqd.endpointName);
           $request.setHeader("serverOrgId", json.mqd.serverOrgId);
           $request.setHeader("x-fapi-interaction-id", json.mqd.fapiInteractionId);

           delete json['mqd'];
           $call.request.getBody().setString( $json.stringify(json), "utf-8" );
           
           $call.request.getAllHeaders().remove("x-clientname-webhooks-signature");
           $call.request.getAllHeaders().remove("access-token");
       } catch (exception) {
           $call.tracer.trace("Exception message => " + exception.message + " <= in line => " + exception.stack);
           $console.debug(">sensedia => Exception", exception);
       }
       ```

:::note[NOTE] 
Consult more information on creating **APIs** in the Sensedia API Platform.
:::

---

### Step 3: Configuring the Custom JS interceptor in the flow of data APIs

In the Sensedia API Platform, select the data APIs eligible for MQD:

1. Add the Custom JS interceptor in the **Flows** step. If there is more than one API, place the interceptor once in each existing API.

2. In the **Resources** field, keep the "All" option.

  ![Adding JS Interceptor in Flow](./img/mqd-data-api-interceptor.png)

  You can configure the Custom JS interceptor as follows:

```javascript title="Configuring the Custom JS interceptor"
const scriptName = String("MQD - Event Producer Interceptor");
const scriptVersion = String("1.1.0");

try {
    
    $call.tracer.trace(">Sensedia debug => Custom javascript: Name [ "+scriptName+" ] version [ "+scriptVersion+" ]." );
    $console.debug("responseStatusCode", $call.response.getStatus());

    if ($call.response.getStatus() == 200 && $call.request.getMethod() == "GET") {

        const url = String($call.request.getRequestedUrl().getPath());
        
        const apiName = extractApiNameByUrl(url);
        
        $console.debug("apiName", apiName);
        
        const mqdTopicUrl = String($call.environmentVariables.get('mqd-'+ apiName +'-topic-handler-url'));

        $console.debug("mqdTopicUrl", mqdTopicUrl);

        if(mqdTopicUrl) {
            
            let jsonResponse = JSON.parse( $call.response.getBody().getString("UTF-8") );
            
            jsonResponse.mqd = {};
            jsonResponse.mqd.endpointName = substituirPathPorPathId(url);
            jsonResponse.mqd.serverOrgId = $call.request.getHeader("x-organisation-id");
            jsonResponse.mqd.fapiInteractionId = $response.getHeader("x-fapi-interaction-id");
            
            const response =  $http.post(mqdTopicUrl, $call.response.getHeaders(), $json.stringify(jsonResponse));
            
            $console.debug("response", response.responseText);
            $console.debug("response status", response.getStatus());
            
            $call.tracer.trace("Custom javascript: Name [ "+scriptName+" ] version [ "+scriptVersion+" ].Envio para MQD Finalizado." );
            
        } else {
            $call.tracer.trace("Custom javascript: Name [ "+scriptName+" ] version [ "+scriptVersion+" ]. ATENCAO!  environmentVariable >'mqd-"+ apiName +"-topic-handler-url'< nao configurada! Ignorando envio para topico MQD." );
        }
    }
} catch (exception) {
    $call.tracer.trace("Exception message => " + exception.message + " <= in line => " + exception.stack);
    $console.debug(">sensedia => Exception", exception);
}

function substituirPathPorPathId(urlSearch) {

  function substituir(match, pathAnterior) {
      const pathId = pathAnterior.slice(0, -1) + 'Id';
      return '/' + pathAnterior + '/{'+pathId+'}';
  }
  let regex = /\/([^\/]+)\/([a-f0-9-]+)(?=\/|$)/g;

  if(apiName === "consents"){
    regex = /\/([^\/]+)\/(urn:[a-zA-Z0-9-]+:[a-f0-9-]+)(?=\/|$)/g;
  }
  
  const novaUrl = urlSearch.replace(regex, substituir);
  
  return novaUrl.match(/open-banking(.+)/)[1];
}

function extractApiNameByUrl(url) {
  const start = "open-banking/";
  const startIndex = url.indexOf(start);

  if (startIndex === -1) {
    return "";
  }

  const endIndex = url.indexOf("/", startIndex + start.length);
  if (endIndex === -1) {
    return url.substring(startIndex + start.length);
  }

  return url.substring(startIndex + start.length, endIndex);
}